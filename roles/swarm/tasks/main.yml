---
# ----------------------------------------
# Initialize swarm ONLY on manager
# ----------------------------------------
- name: Initialize Swarm on manager
  shell: docker swarm init --advertise-addr {{ ansible_host }}
  when: inventory_hostname == groups['manager'][0]
  register: swarm_init
  failed_when: false
  changed_when: "'This node is already part of a swarm' not in swarm_init.stderr"

# ----------------------------------------
# Retrieve join token from MANAGER
# ----------------------------------------
- name: Get worker join token
  shell: docker swarm join-token -q worker
  when: inventory_hostname == groups['manager'][0]
  register: join_token_raw

# Save token so that workers can access it
- name: Save join token as a fact
  set_fact:
    swarm_join_token: "{{ join_token_raw.stdout }}"
  when: inventory_hostname == groups['manager'][0]

# ----------------------------------------
# Workers join the cluster
# ----------------------------------------
- name: Workers join the swarm
  shell: >
    docker swarm join --token {{ hostvars[groups['manager'][0]].swarm_join_token }}
    {{ hostvars[groups['manager'][0]].ansible_host }}:2377
  when: inventory_hostname in groups['workers']
  failed_when: false

# ----------------------------------------
# Deploy Portainer ONLY on manager
# ----------------------------------------
- name: Deploy Portainer using Docker Swarm
  tags: portainer
  shell: |
    docker service create \
      --name portainer \
      --publish 9000:9000 \
      --publish 9443:9443 \
      --constraint 'node.role==manager' \
      --mount type=bind,src=/var/run/docker.sock,dst=/var/run/docker.sock \
      --mount type=bind,src=/opt/portainer,dst=/data \
      portainer/portainer-ce:latest
  when: inventory_hostname == groups['manager'][0]
  failed_when: false
